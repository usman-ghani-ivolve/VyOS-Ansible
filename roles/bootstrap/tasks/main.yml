- name: Conifgure IP Addresses
  vyos.vyos.vyos_config:
    lines:
    - set interfaces ethernet "{{ wan_interface }}" address "{{ wan_ip_address }}"
    - set interfaces ethernet "{{ wan_interface }}" description "{{ wan_interface_description }}"
    - set protocols static route 0.0.0.0/0 next-hop "{{ wan_gateway }}"
    - set interfaces ethernet "{{ mgmt_interface }}" address "{{ mgmt_ip_address }}"
    - set interfaces ethernet "{{ mgmt_interface }}" description "{{ mgmt_interface_description }}"
    - set interfaces ethernet {{ lan_interface }} address {{ lan_ip_address }}
    - set interfaces ethernet {{ lan_interface }} description {{ lan_interface_description }}

- name: Conifgure DHCP Service
  vyos.vyos.vyos_config:
    lines:
    - set service dhcp-server shared-network-name {{ lan_interface_description }} subnet "{{ lan_subnet }}"
    - set service dhcp-server shared-network-name {{ lan_interface_description }} subnet "{{ lan_subnet }}" range 0 start "{{ dhcp_start }}"
    - set service dhcp-server shared-network-name {{ lan_interface_description }} subnet "{{ lan_subnet }}" range 0 stop "{{ dhcp_end }}"
    - set service dhcp-server shared-network-name {{ lan_interface_description }} subnet "{{ lan_subnet }}" default-router "{{ default_router }}"
    - set service dhcp-server shared-network-name {{ lan_interface_description }} subnet "{{ lan_subnet }}" dns-server "{{ dns_server }}"

- name: Conifgure SNAT
  vyos.vyos.vyos_config:
    lines:
    - set nat source rule 100 source address "{{ lan_subnet  }}"
    - set nat source rule 100 outbound-interface "{{ wan_interface }}"
    - set nat source rule 100 translation address masquerade

- name: Conifgure DNS Service
  vyos.vyos.vyos_config:
    lines:
    - set service dns forwarding cache-size '0'
    - set service dns forwarding listen-address "{{ default_router }}"
    - set service dns forwarding allow-from "{{ lan_subnet }}"
    - set service dns forwarding name-server {{ dns_server }}

- name: Configuring Firewall
  vyos.vyos.vyos_firewall_rules:
    config:
    - afi: ipv4
      rule_sets:
      - name: OUTSIDE-IN
        default_action: drop
        rules:
        - number: {{ default_rule_number }}
          action: accept
          state: 
            established: true
            related: true
      - name: OUTSIDE-LOCAL
        default_action: drop
        rules:
        - number: {{ default_rule_number }}
          action: accept
          state:
            established: true
            related: true
    state: merged

- name: Applying FW Rules
  vyos.vyos.vyos_firewall_interfaces:
    config:
    - access_rules:
      - afi: ipv4
        rules:
        - name: OUTSIDE-IN
          direction: in
      name: {{ wan_interface }}
    - access_rules:
      - afi: ipv4
        rules:
        - name: OUTSIDE-LOCAL
          direction: local
      name: {{ wan_interface }}
    state: merged