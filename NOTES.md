"function" variable should not be used globally. Results in infinite loop.
Try to refrence other vars globally
If firewall rule is created we must check for rule set  existance